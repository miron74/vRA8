formatVersion: 1
inputs:
  os:
    type: string
    title: Sistema Operativo
    oneOf:
      - title: RedHat 8.0 Ingles
        const: w01-clnegro-pro-001 / GN_AGE_REDHAT_8.0_ENG
      - title: RedHat 8.0 Español
        const: w01-clnegro-pro-001 / GN_AGE_REDHAT_8.0_ESP
      - title: RedHat 8.4 Ingles
        const: w01-clnegro-pro-001 / GN_AGE_REDHAT_8.4_ENG
      - title: RedHat 8.4 Español
        const: w01-clnegro-pro-001 / GN_AGE_REDHAT_8.4_ESP
  cpuCount:
    type: integer
    title: Número CPUs
    description: Seleccione el número de CPUs
    minimum: 1
    maximum: 32
  memoryCount:
    type: integer
    title: Memoria (GB)
    description: Seleccione la cantidad de Memoria
    minimum: 1
    maximum: 256
  justification:
    type: string
    title: Justificación
    description: Esta petición requiere justificación debido al número de CPUs o a la cantidad de memoria seleccionada. Por favor, introduzca la justificación y su aprobación será evaluada.
  networkManagementEnabled:
    type: boolean
    title: Habilitar la red de gestión
    default: true
  networkService:
    type: string
    title: Selecciona Red Servicio
  ipAddressService:
    type: string
    title: IP Servicio
    pattern: ^((25[0-5]|(2[0-4]|1\d|[1-9]|)\d)\.?\b){4}$
    description: Introduzca una dirección ip valida
  networkManagement:
    type: string
    title: Selecciona Red Gestión
  ipAddressManagement:
    type: string
    title: IP Gestion
    pattern: ^((25[0-5]|(2[0-4]|1\d|[1-9]|)\d)\.?\b){4}$
    description: Introduzca una dirección ip valida
    default: null
  rootPassword:
    type: string
    title: Contraseña usuario root
    encrypted: true
    readOnly: false
    description: Contraseña de Root
    minLength: 8
    pattern: ^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[_\[\]\()\/\~=+#?!@$%^&*-]).{8,}$
  repeatRootPassword:
    type: string
    encrypted: true
    readOnly: false
    title: Repetir Contraseña Root
  adminPassword:
    type: string
    title: Contraseña usuario admin
    readOnly: false
    encrypted: true
    minLength: 8
    pattern: ^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[_\[\]\()\/\~=+#?!@$%^&*-]).{8,}$
  repeatAdminPassword:
    type: string
    encrypted: true
    title: Repetir Contraseña admin
resources:
  Maquina_Virtual:
    type: Cloud.vSphere.Machine
    metadata:
      layoutPosition:
        - 0
        - 0
    networks: ${map_by(resource.Red_Servicio[*].* + resource. Red_Gestion[*].*, r => {"network":r.id, "assignment":"static", "deviceIndex":r.deviceIndex})}
    properties:
      imageRef: ${input.os}
      cpuCount: ${input.cpuCount}
      totalMemoryMB: ${input.memoryCount*1024}
      snapshotLimit: 3
      Infoblox.IPAM.Network0.hostnameNicSuffix: ''
      Infoblox.IPAM.Network1.hostnameNicSuffix: ''
      folderName: ${"Entidades/" + env.projectName}
      rootPassword: ${input.rootPassword}
      repeatRootPassword: ${input.repeatRootPassword}
      adminPassword: ${input.adminPassword}
      repeatAdminPassword: ${input.repeatAdminPassword}
      customizationSpec: Customization-vRealizeAutomation-Linux
      constraints:
        - tag: recursos:linux
      # Funciona pero hay no permite asignacion de IP manual
      #networks: ${map_by(resource.Red_Servicio[*].* + resource.Red_Gestion[*].* , r => {"network":r.id, "assignment":"static", "deviceIndex":r.deviceIndex})}
      networks: ${[{"network":resource.Red_Servicio.id, "assignment":"static", "deviceIndex":0, "address":input.ipAddressService}] + map_by(resource.Red_Gestion[*].id, id => {"network":id, "assignment":"static", "address":input.ipAddressManagement, "gateway":""})}
  Red_Servicio:
    type: Cloud.vSphere.Network
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      networkType: existing
      constraints:
        - tag: ${input.networkService}
        - tag: red-gestion:falso
        - tag: segmentos:overlay
  Red_Gestion:
    type: Cloud.vSphere.Network
    metadata:
      layoutPosition:
        - 2
        - 0
    properties:
      networkType: existing
      constraints:
        - tag: ${input.networkManagement}
        - tag: red-gestion:verdadero
        - tag: segmentos:overlay
      count: '${input.networkManagementEnabled == true ? 1 : 0}'
